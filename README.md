## gachiFighterBot

### Описание
Телеграм бот, который умеет выбирать пидора дня, ведет статистику, а также способен организовывать поединки. 

### Фичи
- /pidor - Выбрать пидора дня
- /register - Зарегистрироваться
- /rating - Рейтинг пидорасов
- /duel, /accept - Вызов на бой / принять бой
- /fight_stats - Статистика боев

### Техническое описание
- Бот состоит из основного файла main.py, которые содержит асинхронные функции, отвечающие за различный функционал.
- Для реализации фичей используется база данных postgresql для хранения пользователей, истории, статистики и т.д. 
- Изменения вносимые в базу данных регулируются с помощью миграций (migrations).

## Релизный процесс
1) После тестирования и перед влитием ПР в основную ветку добавляем тэг. К примеру, после ```git commit``` выполняем ```git tag -a v1.X.0 -m "Release of version 1.X.0```. Затем делаем ```git push origin my_branch```.
2) После этого ждем выполнение джобы Build & Publish Docker Images to Docker Hub.
3) Затем в ручном режиме запускаем джобу Manual Trigger Workflow передав в качестве входных параметров созданный тэг без префикса v (к примеру, 1.0.0).
4) Ждем завершения джобы и проверяем работу бота.
5) Готово.

## Для разработчиков
### Инструкция по работе с миграциями:
1) Вносить изменения нужно поэтапно (ни в коем случае не править старые миграции).
2) Миграции лежат в папке migrations.
3) Там создаем папку, к примеру, r2 (предыдущая , к примеру, была r1). Далее создаем конкретную миграцию (еще одну папку), кладем туда sql файл с изменениями + создаем (в r2) changelog.xml по примеру предыдущих миграций.
4) В корневой папке migrations вносим изменения еще в один changelog.xml (верхнеуровневый).
5) Готово. 

### Инструкция как вносить изменения в код:
1) Устанавливаем docker локально.
2) Клонируем репозиторий.
3) Создаем .env файл по аналогии с .env.template.
4) Запускаем dev окружение в контейнерах (dev база для тестов), чтобы туда можно было достучаться.
5) Для запуска используем yaml конфиг docker-compose.dev.yaml и команду:
```sh
docker compose -f docker-compose.dev.yaml up --build --force-recreate
```
6) Вносим необходимые изменения в коде, тестируем с помощью бота test-gachi-fighter-bot.
7) Если все ок, не было ошибок, миграции прошли. Делаем MR.
8) Отправляем на ревью.
9) Готово.
- Чтобы полностью очистить docker от барахла и заново постестировать базу, можно использовать
```sh
docker rm -f $(docker ps -a -q) && docker volume rm $(docker volume ls -q) && docker rmi -f $(docker images -q) && docker builder prune -a
```

### Инструкции по прокидыванию портов для разработки бота на вебхуках
1) Скачиваем ngrok (https://ngrok.com/)
2) В отдельном терминале запускаем:
```sh
ngrok http --domain=<бесплатный статичный домен, который можно запросить в админке ngrok> 8083
```
3) В переменных окружения указываем:
```sh
WEBHOOK_HOST=<бесплатный статичный домен, который можно запросить в админке ngrok>
```
4) Запускаем бота на порту 8083.
5) Проверяем что запросы доходят до бота.
6) Готово.

## Релизы
### v.1.6.0
- Оптимизирован вывод статистики по поединкам
- В историю поединков передается выбранное оружие для будущей аналитики
- Реализована новая модель распределения очков в дуэли. Добавлены слабая и легендарная комбинация.

### v.1.5.0
- Рефакторинг с поллинга на вебхуки

### v.1.4.0
- Рефакторинг метода принятия дуэли
- Реализован выбор оружия при борьбе. А также добавлены соответствующие текстовки ♂

### v.1.3.0
- Теперь бот изолирован в рамках группы и вся статистика теперь будет в рамках только одного телеграм канала.
- Добавил картинки для открытых дуэлей

### v.1.2.0
- Добавлен новый столбец в базе - тип дуэлей
- Пофиксили методы дуэлей - изолировали различные сценарии вызова / принятия. Доработали текстовки.
- Добавили документ релизов. 
- Убрали пинговку из метода статистики и добавили нумерацию пользователей.

### v.1.1.0
- Добавлено больше gif изображений борьбы
- Добавлен метод случайно извлечения гиф изображений
- Замена команды /start на команду /pidor

### v.1.0.0
- MVP версия, реализованы функции поиска пидора дня, открытые дуэли с ♂jabronis♂, методы вызова статистики
