## gachiFighterBot

### Описание
Телеграм бот, который умеет выбирать пидора дня, ведет статистику, а также способен организовывать поединки. 

### Фичи
- /pidor - выбрать пидора дня
- /register - зарегистрироваться
- /rating - рейтинг пидоров
- /fight, /fight @username - вызов на бой (открытая дуэль / с конкретным участником)
- /fight_stats - статистика боев
- /hit @username - ударить игрока по лбу с помощью ♂Dick♂
- /global_fight_stats - глобальная статистика боев
- /release, /release 1.0 - посмотреть изменения в текущем релизе / выбранном релизе

### Техническое описание
- Бот состоит из основного файла main.py, которые содержит методы для запуска приложения. Все методы разведены по модулям: bot (команды, основной функционал), database (подключение к БД) и utils (различные сервисные / аналитические функции).
- Для реализации фичей используется база данных postgresql для хранения пользователей, истории, статистики и т.д. 
- Изменения вносимые в базу данных регулируются с помощью миграций (migrations).

## Релизный процесс
1) После тестирования и перед влитием ПР в основную ветку добавляем тэг. К примеру, после ```git commit``` выполняем ```git tag -a v1.X.0 -m "Release of version 1.X.0```. Затем делаем ```git push origin my_branch --tags```.
2) После этого ждем выполнение джобы Build & Publish Docker Images to Docker Hub.
3) Затем в ручном режиме запускаем джобу Manual Trigger Workflow передав в качестве входных параметров созданный тэг без префикса v (к примеру, 1.0.0).
4) Ждем завершения джобы и проверяем работу бота.
5) Готово.

## Для разработчиков
### Инструкция по работе с миграциями:
1) Вносить изменения нужно поэтапно (ни в коем случае не править старые миграции).
2) Миграции лежат в папке migrations.
3) Там создаем папку, к примеру, r2 (предыдущая , к примеру, была r1). Далее создаем конкретную миграцию (еще одну папку), кладем туда sql файл с изменениями + создаем (в r2) changelog.xml по примеру предыдущих миграций.
4) В корневой папке migrations вносим изменения еще в один changelog.xml (верхнеуровневый).
5) Готово. 

### Инструкция как вносить изменения в код:
1) Устанавливаем docker локально.
2) Клонируем репозиторий.
3) Создаем .env файл по аналогии с .env.template.
4) Запускаем dev окружение в контейнерах (dev база для тестов), чтобы туда можно было достучаться.
5) Для запуска используем yaml конфиг docker-compose.dev.yaml и команду:
```sh
docker compose -f docker-compose.dev.yaml up --build --force-recreate
```
6) Вносим необходимые изменения в коде, тестируем с помощью бота test-gachi-fighter-bot.
7) Если все ок, не было ошибок, миграции прошли. Делаем MR.
8) Отправляем на ревью.
9) Готово.
- Чтобы полностью очистить docker от барахла и заново постестировать базу, можно использовать
```sh
docker rm -f $(docker ps -a -q) && docker volume rm $(docker volume ls -q) && docker rmi -f $(docker images -q) && docker builder prune -a
```

### Инструкции по прокидыванию портов для разработки бота на вебхуках
1) Скачиваем ngrok (https://ngrok.com/)
2) В отдельном терминале запускаем:
```sh
ngrok http --domain=<бесплатный статичный домен, который можно запросить в админке ngrok> 8083
```
3) В переменных окружения указываем:
```sh
WEBHOOK_HOST=<бесплатный статичный домен, который можно запросить в админке ngrok>
```
4) Запускаем бота на порту 8083.
5) Проверяем что запросы доходят до бота.
6) Готово.

## Релизы
### v.1.12.0
- Добавили возможность брать в долг у других ♂jabroni♂ (/get_semen), а также потом гасить эти долги (/return_semen).
- Теперь пидор дня получает +100 мл. ♂semen♂
- Бороться с нулевым или отрицательным ♂semen♂ теперь нельзя.
- Добавили более агрессивную текстовку, когда кто-то нажимает выбор оружия не в свою очередь.
- Продлили время охлаждения перед следующей борьбой, чтобы избежать зависание.

### v.1.11.0
- Долгожданная доработка "камень-ножницы-бумага": теперь победа зависит от выбора оружия. ♂Dick♂ бьет ♂Ass♂, ♂Ass♂ бьет ♂Finger♂, а ♂Finger♂ бьет ♂Dick♂. В случае ничьи, выбор оружия начинается заново. 
- Добавили показ количества секунд до того, как можно создать новую дуэль.

### v.1.10.4
Чтобы не конфликтовать с другими ботами в чатах:
- Изменена команда вызова дуэли /duel → /fight
- Изменена команда удара ♂Dick♂ по лбу оппонента: /slap @username → /hit @username

### v.1.10.0
- Убрали команду accept. Теперь принятие дуэли для удобства сделано кнопкой.
- Фикс бага, что дуэль все равно можно продолжить, даже если она просрочена (не завершена).
- Теперь на принятие дуэли дается 15 минут, а после каждого действия +10 минут.
- Фикс бага, при котором в процессе выбора оружия участникам не приходит пинг.
- Эксперимент: теперь пидор дня может один раз ударить членом любого участника чата и отнять ⚣semen⚣ (/slap @username)

### v.1.9.0
- Добавлены новые текстовки к выбору пидора дня
- Реализована глобальная статистика по борьбе /global_fight_stats
- Реализован метод для публикации последних изменений /release

### v.1.8.0
- Проведен большой рефакторинг. Теперь кодовая база разбита на модули.
- Продлили длительность принятия дуэли с 5 до 10 минут.
- Добавлены новые текстовки для результатов боев.
- Пофиксили баг с отрицательным балансом.
- При открытой дуэли подписали в сообщений, кто ее объявил.

### v.1.7.0
- Внесена доработка статуса дуэли, чтобы избежать одновременного принятия двух дуэлей сразу одной командой.
- Введен период охлаждения между дуэлями и запрет создавать дуэли, если создано или в процессе уже минимум две.

### v.1.6.0
- Оптимизирован вывод статистики по поединкам.
- В историю поединков передается выбранное оружие для будущей аналитики.
- Реализована новая модель распределения очков в дуэли. Добавлены слабая и легендарная комбинация.

### v.1.5.0
- Рефакторинг с поллинга на вебхуки

### v.1.4.0
- Рефакторинг метода принятия дуэли
- Реализован выбор оружия при борьбе. А также добавлены соответствующие текстовки ♂

### v.1.3.0
- Теперь бот изолирован в рамках группы и вся статистика теперь будет в рамках только одного телеграм канала.
- Добавил картинки для открытых дуэлей

### v.1.2.0
- Добавлен новый столбец в базе - тип дуэлей
- Пофиксили методы дуэлей - изолировали различные сценарии вызова / принятия. Доработали текстовки.
- Добавили документ релизов. 
- Убрали пинговку из метода статистики и добавили нумерацию пользователей.

### v.1.1.0
- Добавлено больше gif изображений борьбы
- Добавлен метод случайно извлечения гиф изображений
- Замена команды /start на команду /pidor

### v.1.0.0
- MVP версия, реализованы функции поиска пидора дня, открытые дуэли с ♂jabronis♂, методы вызова статистики
